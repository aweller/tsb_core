# files = {"R_2013_07_10_15_08_33_user_OX1-214-TSB_150-Panel_version_1":"10E",
# "R_2013_07_12_05_50_30_user_OX2-196-TSB_150-Panel_version_1":"10F",
# "R_2013_07_02_06_21_38_user_OX2-182-TSB_150-Panel_version_1":"8C",
# "R_2013_06_30_20_56_43_user_OX1-201-TSB_150-Panel_version_1":"8D",
# "R_2013_04_09_18_21_13_user_OX1-156-TSB_150-Panel_version_1":"9E",
# "R_2013_04_14_15_34_04_user_OX1-159-TSB_150-Panel_version_1":"9G",
# "R_2013_04_16_06_14_53_user_OX2-140-TSB_150-Panel_version_1":"9H",
# "R_2013_07_17_20_10_46_user_OX1-221-TSB_150-Panel_version_1":"10A",
# "R_2013_07_09_20_29_31_user_OX1-213-TSB_150-Panel_version_1":"10C",
# "R_2013_07_11_11_09_23_user_OX2-195-TSB_150-Panel_version_1":"10D",
# "R_2013_07_10_20_55_32_user_OX1-215-TSB_150-Panel_version_1":"10G",
# "R_2013_06_12_18_58_22_user_OX1-190-TSB_150-Panel_version_1":"485",
# "R_2013_06_18_15_10_36_user_OX1-194-TSB_150-Panel_version_1":"7E",
# "R_2013_06_20_05_51_46_user_OX2-176-TSB_150-Panel_version_1":"7F"}

# files = {"R_2013_06_26_16_00_30_user_OX1-198-TSB_150-Panel_version_1":"7H",
# "R_2013_04_05_21_21_44_user_OX1-154-TSB_150-Panel_version_1":"9D",
# "R_2013_04_11_09_02_35_user_OX2-137-TSB_150-Panel_version_1":"9F",
# "R_2013_04_09_18_21_13_user_OX1-156-TSB_150-Panel_version_1":"9E",
# "R_2013_04_16_06_14_53_user_OX2-140-TSB_150-Panel_version_1":"9H"}
#     
# 
# files = {"/results/analysis/output/Home/Auto_user_OX1-198-TSB_150-Panel_version_1_412_643":"7H",    
# "/gpfs1/well/brc/archivedReports/user_OX1-154-TSB_150-Panel_version_1_487":"9D",
# "/gpfs1/well/brc/archivedReports/OX2-137_498":"9F",
# "/gpfs1/well/brc/archivedReports/OX2-137_542":"9F",
# "/gpfs1/well/brc/archivedReports/OX1-156_538":"9E",
# "/gpfs1/well/brc/archivedReports/OX2-140_533":"9H"}

files = {"Auto_user_OX1-191-TSB_150-Panel_version_1_397":"7C",
"Auto_user_OX2-173-TSB_150-Panel_version_1_398":"7D",
"Auto_user_OX2-180-TSB_150-Panel_version_1_413":"8A",
"Auto_user_OX1-207-TSB_150-Panel_version_1_431":"8F",
"Auto_user_OX1-229-TSB_150-Panel_version_1_476":"9A",
"Auto_user_OX2-63_136":"9C",
"Auto_user_OX1-191-TSB_150-Panel_version_1_397":"7G",
"R_2013_06_26_16_00_30_user_OX1-198-TSB_150-Panel_version_1":"7H",
"Auto_user_OX1-200-TSB_150-Panel_version_1_417":"8B",
"Auto_user_OX1-205-TSB_150-Panel_version_1_429":"8E",
"Auto_user_OX1-212-TSB_150-Panel_version_1_442":"8G",
"Auto_user_OX2-194-TSB_150-Panel_version_1_443":"8H"}

all_files =  {"R_2013_07_10_15_08_33_user_OX1-214-TSB_150-Panel_version_1":"10E",
"R_2013_07_12_05_50_30_user_OX2-196-TSB_150-Panel_version_1":"10F",
"R_2013_07_02_06_21_38_user_OX2-182-TSB_150-Panel_version_1":"8C",
"R_2013_06_30_20_56_43_user_OX1-201-TSB_150-Panel_version_1":"8D",
"R_2013_04_09_18_21_13_user_OX1-156-TSB_150-Panel_version_1":"9E",
"R_2013_04_14_15_34_04_user_OX1-159-TSB_150-Panel_version_1":"9G",
"R_2013_04_16_06_14_53_user_OX2-140-TSB_150-Panel_version_1":"9H",
"R_2013_07_17_20_10_46_user_OX1-221-TSB_150-Panel_version_1":"10A",
"R_2013_07_09_20_29_31_user_OX1-213-TSB_150-Panel_version_1":"10C",
"R_2013_07_11_11_09_23_user_OX2-195-TSB_150-Panel_version_1":"10D",
"R_2013_07_10_20_55_32_user_OX1-215-TSB_150-Panel_version_1":"10G",
"R_2013_06_12_18_58_22_user_OX1-190-TSB_150-Panel_version_1":"485",
"R_2013_06_18_15_10_36_user_OX1-194-TSB_150-Panel_version_1":"7E",
"R_2013_06_20_05_51_46_user_OX2-176-TSB_150-Panel_version_1":"7F",
"R_2013_06_26_16_00_30_user_OX1-198-TSB_150-Panel_version_1":"7H",
"R_2013_04_05_21_21_44_user_OX1-154-TSB_150-Panel_version_1":"9D",
"R_2013_04_11_09_02_35_user_OX2-137-TSB_150-Panel_version_1":"9F",
"R_2013_04_09_18_21_13_user_OX1-156-TSB_150-Panel_version_1":"9E",
"R_2013_04_16_06_14_53_user_OX2-140-TSB_150-Panel_version_1":"9H",
"/results/analysis/output/Home/Auto_user_OX1-198-TSB_150-Panel_version_1_412_643":"7H",    
"/gpfs1/well/brc/archivedReports/user_OX1-154-TSB_150-Panel_version_1_487":"9D",
"/gpfs1/well/brc/archivedReports/OX2-137_498":"9F",
"/gpfs1/well/brc/archivedReports/OX2-137_542":"9F",
"/gpfs1/well/brc/archivedReports/OX1-156_538":"9E",
"/gpfs1/well/brc/archivedReports/OX2-140_533":"9H",
"Auto_user_OX1-191-TSB_150-Panel_version_1_397":"7C",
"Auto_user_OX2-173-TSB_150-Panel_version_1_398":"7D",
"Auto_user_OX2-180-TSB_150-Panel_version_1_413":"8A",
"Auto_user_OX1-207-TSB_150-Panel_version_1_431":"8F",
"Auto_user_OX1-229-TSB_150-Panel_version_1_476":"9A",
"Auto_user_OX2-63_136":"9C",
"Auto_user_OX1-191-TSB_150-Panel_version_1_397":"7G",
"R_2013_06_26_16_00_30_user_OX1-198-TSB_150-Panel_version_1":"7H",
"Auto_user_OX1-200-TSB_150-Panel_version_1_417":"8B",
"Auto_user_OX1-205-TSB_150-Panel_version_1_429":"8E",
"Auto_user_OX1-212-TSB_150-Panel_version_1_442":"8G",
"Auto_user_OX2-194-TSB_150-Panel_version_1_443":"8H"}


import os
import sys
import subprocess


run_to_analysis = {}
analysis_to_barcode = {}
all_analyses = []

with open("ffdna_samples.txt") as ffdna_files:
    for row in ffdna_files:
        f = row.rstrip("\r\n").split("\t")
        run = f[0]
        barcode = f[1].lstrip("bc")
        analysis = f[2]
        
        run_to_analysis[run] = analysis 
        analysis_to_barcode[analysis] = barcode
        all_analyses.append([run, barcode, analysis])
        
# create folders
# for filename, code in files.iteritems():
#     mk_cmd = "mkdir VICindels_%s" % (code) 
#     os.system(mk_cmd) 

# create scp commands for backup folders
# for run, code in ffdna.iteritems():
#      scp_cmd = "scp ionadmin@FQ590R1:/results/analysis/output/Home/%s*/download_links/*.zip /home/ionadmin/CallValidation/RerunTVC/ffdna/" % (run)
#     scp_cmd = "cp %s*/download_links/*.zip ./to_export/ &" % (run)
#     subprocess.call(scp_cmd, shell=True)
    
#     print scp_cmd


# create scp commands for manual execution
# for filename, code in files.iteritems():
#     with open("foldernames.txt") as folders:
#         for row in folders:
#             if filename.split("_user_")[1] in row:    
#                 scp_cmd = "scp ionadmin@FQ590R1:/results/analysis/output/Home/%s/download_links/*.zip ./VICindels_%s" % (row.strip("\n"), code)
#                 print scp_cmd 

# unzip all files
# for filename, code in files.iteritems():
#     zipfiles = os.listdir("./VICindels_%s" % code)
#   
#     for file in zipfiles:
#         zip_cmd = "unzip ./VICindels_%s/%s -d ./VICindels_%s/" % (code, file, code)
#         os.system(zip_cmd)
        
# create TVC commands for manual execution

# rename all files

folder = sys.argv[1]
all_files = [x for x in os.listdir(folder) if x.endswith(".bam") or x.endswith(".bai") and "IonXpress_" in x]

for file in all_files:
    for item in all_analyses:
        if item[0] in file and item[1]+"_R" in file:
            filetype = ".bam" if "bai" not in file else ".bam.bai"
            new_filename = item[2] + filetype
            rename_cmd = "mv %s%s %s%s" % (folder, file, folder, new_filename)
            print rename_cmd
            subprocess.call(rename_cmd, shell=True)


# printed = []
# for filename, code in all_files.iteritems():
#     bamfiles = [x for x in os.listdir("./VICindels_%s" % code) if x.endswith("bam") and "basecaller" not in x]
#        
# #     print code, bamfiles
#        
#     for bam in bamfiles:
#         if "_004_" in bam or "_002_" in bam:
#                
#              tvc_cmd = """python /results/plugins/variantCaller/variantCaller.py -b /home/ionadmin/CallValidation/RerunTVC/genepanel_148_amplicons.bed -r /results/uploads/hg19.fasta \
#              -i /home/ionadmin/CallValidation/RerunTVC/VICindels_%s/%s  -o /home/ionadmin/CallValidation/RerunTVC/VICindels_%s/ \
#              -p /home/ionadmin/CallValidation/RerunTVC/custom.json -B ./""" % (code, bam, code)
#              
#              if code not in printed:
#                  print "\t".join(["VICindels_"+code, bam, sys.argv[1]])
#              
# #              print "---------------------"
# #              print code              
#              print tvc_cmd
